name: Deploy AWS Lambda + S3

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

concurrency:
  group: deploy-production
  cancel-in-progress: true

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  LAMBDA_FUNCTION_NAME: ${{ vars.LAMBDA_FUNCTION_NAME }}
  WEB_BUCKET_NAME: ${{ vars.WEB_BUCKET_NAME }}

jobs:
  deploy-lambda:
    name: Deploy Lambda
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Package Lambda
        run: |
          cd lambda
          zip -r ../lambda-package.zip . -x '*.pyc' '*__pycache__*'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update Lambda function code
        run: |
          aws lambda update-function-code \
            --function-name "$LAMBDA_FUNCTION_NAME" \
            --zip-file "fileb://lambda-package.zip"

  deploy-web:
    name: Deploy web to S3
    runs-on: ubuntu-latest
    needs: deploy-lambda

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Sync static site
        run: |
          aws s3 sync web "s3://$WEB_BUCKET_NAME" --delete

      - name: Disable cache for HTML
        run: |
          aws s3 cp web/index.html "s3://$WEB_BUCKET_NAME/index.html" \
            --content-type "text/html" \
            --cache-control "no-cache, no-store, must-revalidate"
