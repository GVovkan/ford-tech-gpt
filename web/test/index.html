<!-- web/test/index.html (v0.19-test) -->
<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ford Tech Story Creator TEST - v0.19</title>
  <link rel="stylesheet" href="../styles.css?v=0.19">
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>Ford Tech Story Creator</h1>
        <div class="pill">v0.19-test</div>
      </div>

      <div class="topRight">
        <div class="pill subtle">TEST sandbox - do all innovations here first</div>
        <div class="menuWrap">
          <button class="menuBtn" id="menuBtn" type="button" onclick="toggleSettingsMenu()" aria-expanded="false">Menu</button>
          <div class="settingsMenu" id="settingsMenu" role="menu" aria-label="Settings menu">
            <div class="menuRow">
              <span class="menuLabel">Theme</span>
              <button class="themeBtn menuThemeBtn" id="themeBtn" type="button" onclick="toggleTheme()" aria-label="Toggle theme">
                <span class="themeDot" aria-hidden="true"></span>
                <span id="themeLabel">Dark</span>
              </button>
            </div>
            <div class="menuLabel">GPT model</div>
            <select id="modelPreset" onchange="applyModelPreset()">
              <option value="">Model preset</option>
              <option value="gpt-4.1-mini">gpt-4.1-mini</option>
              <option value="gpt-4.1">gpt-4.1</option>
              <option value="gpt-4o-mini">gpt-4o-mini</option>
              <option value="gpt-4o">gpt-4o</option>
              <option value="gpt-5">gpt-5</option>
              <option value="gpt-5.1">gpt-5.1</option>
              <option value="gpt-5.2">gpt-5.2</option>
            </select>
            <input id="modelInput" type="text" placeholder="or enter any model id" spellcheck="false" />
            <div class="vinHint">Saved locally for /test settings.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="cardHeader">
        <div>
          <div class="cardTitle">Inputs</div>
          <div class="subtitle">Simple flow: pick story mode, pick job type, add VIN/mileage, then write diagnosis and repair.</div>
        </div>
      </div>

      <div class="grid">
        <div class="field">
          <label>Story Mode</label>
          <select id="sectionMode">
            <option value="diag_only">Diag only</option>
            <option value="repair_only">Repair only</option>
            <option value="diag_repair" selected>Diag + Repair</option>
          </select>
        </div>

        <div class="field">
          <label>Job Type</label>
          <select id="mode">
            <option>Warranty</option>
            <option>CP</option>
          </select>
        </div>

        <div class="field">
          <label>VIN</label>
          <div class="vinWrap">
            <input id="vin" class="vinInput" autocomplete="off" autocapitalize="characters" spellcheck="false" placeholder="1FM..." />
            <button class="vinDropBtn" type="button" onclick="toggleVinDropdown()" aria-label="VIN history">&#9662;</button>

            <div id="vinDropdown" class="vinDropdown" role="listbox" aria-label="VIN history">
              <div class="vinDropdownHeader">
                <div class="vinDropdownTitle">Recent VINs</div>
                <button class="vinClearBtn" type="button" onclick="clearVinHistory()">Clear</button>
              </div>
              <div id="vinDropdownList" class="vinDropdownList"></div>
            </div>
          </div>
          <div class="vinHint">Tip - click the arrow for recent VINs</div>
        </div>

        <div class="field">
          <label>Mileage</label>
          <input id="mileage" type="text" placeholder="Example: 104532" inputmode="numeric" />
        </div>

        <div class="field">
          <label>Diagnosis</label>
          <textarea id="diagnosis" placeholder="What you checked - what you found - tests/measurements/codes."></textarea>
        </div>

        <div class="field">
          <label>Repair</label>
          <textarea id="repair" placeholder="What you repaired/replaced/programmed - recheck results."></textarea>
        </div>

        <div class="field grid3" style="grid-column: 1 / -1;">
          <div>
            <label>Parts Used</label>
            <textarea id="parts" placeholder="Part numbers / quantities if applicable."></textarea>
          </div>
          <div>
            <label>Time / Justification</label>
            <textarea id="time" placeholder="Hours spent and why (intermittent, repeated programming, wiring tracing, etc.)."></textarea>
          </div>
          <div>
            <label>Notes</label>
            <textarea id="extra" placeholder="Concern and any extra notes you want included."></textarea>
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="btnGenerate" class="btnPrimary" type="button" onclick="generate()">
          <span class="btnLabel">Generate</span>
          <span class="btnSpinner" aria-hidden="true"></span>
        </button>
        <button class="btnGhost" type="button" onclick="copyOut()">Copy</button>
        <button class="btnGhost" type="button" onclick="clearAll()">Clear</button>
        <div class="status" id="status"></div>
      </div>

      <div class="outWrap">
        <div id="out" class="out"></div>

        <div id="skeleton" class="skeletonOverlay" aria-hidden="true">
          <div class="skeletonCard">
            <div class="skLine w60"></div>
            <div class="skLine w92"></div>
            <div class="skLine w88"></div>
            <div class="skLine w95"></div>
            <div class="skLine w78"></div>
            <div class="skLine w90"></div>
            <div class="skLine w70"></div>
            <div class="skLine w94"></div>
            <div class="skLine w83"></div>
            <div class="skLine w76"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">(c) Vovkan</div>
  </div>

<script>
const API_URL = "https://wubhcgbdlh.execute-api.ca-west-1.amazonaws.com/generate";
const VIN_STORE_KEY = "vovkan_vins";
const THEME_KEY = "vovkan_theme";
const SETTINGS_KEY = "vovkan_settings";

function setStatus(msg, ok=null){
  const s = document.getElementById("status");
  s.textContent = msg || "";
  if (ok === true) s.style.color = "var(--ok)";
  else if (ok === false) s.style.color = "var(--bad)";
  else s.style.color = "var(--muted)";
}

function setLoading(isLoading){
  const btn = document.getElementById("btnGenerate");
  const sk = document.getElementById("skeleton");

  if (isLoading){
    btn.classList.add("isLoading");
    btn.disabled = true;
    sk.classList.add("show");
  } else {
    btn.classList.remove("isLoading");
    btn.disabled = false;
    sk.classList.remove("show");
  }
}

function getTheme(){
  return localStorage.getItem(THEME_KEY) || "dark";
}

function setTheme(theme){
  document.documentElement.setAttribute("data-theme", theme);
  localStorage.setItem(THEME_KEY, theme);

  const label = document.getElementById("themeLabel");
  const dot = document.querySelector(".themeDot");
  if (theme === "light"){
    label.textContent = "Light";
    dot.classList.add("on");
  } else {
    label.textContent = "Dark";
    dot.classList.remove("on");
  }
}

function toggleTheme(){
  setTheme(getTheme() === "dark" ? "light" : "dark");
}

function loadVinHistory(){
  try {
    const raw = localStorage.getItem(VIN_STORE_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  } catch {
    return [];
  }
}

function saveVinHistory(vins){
  localStorage.setItem(VIN_STORE_KEY, JSON.stringify(vins.slice(0, 12)));
}

function addVinToHistory(vin){
  vin = (vin || "").trim().toUpperCase();
  if (!vin) return;

  let vins = loadVinHistory();
  vins = vins.filter(v => v !== vin);
  vins.unshift(vin);
  saveVinHistory(vins);
  renderVinDropdown();
}

function clearVinHistory(){
  localStorage.removeItem(VIN_STORE_KEY);
  renderVinDropdown();
  setStatus("VIN history cleared", true);
}

function renderVinDropdown(){
  const list = document.getElementById("vinDropdownList");
  const vins = loadVinHistory();

  list.innerHTML = "";
  if (vins.length === 0){
    const empty = document.createElement("div");
    empty.className = "vinEmpty";
    empty.textContent = "No VINs saved yet";
    list.appendChild(empty);
    return;
  }

  vins.forEach(v => {
    const item = document.createElement("button");
    item.type = "button";
    item.className = "vinItem";
    item.textContent = v;
    item.onclick = () => {
      document.getElementById("vin").value = v;
      closeVinDropdown();
    };
    list.appendChild(item);
  });
}

function toggleVinDropdown(){
  const dd = document.getElementById("vinDropdown");
  dd.classList.toggle("show");
  renderVinDropdown();
}

function closeVinDropdown(){
  document.getElementById("vinDropdown").classList.remove("show");
}

function toggleSettingsMenu(){
  const menu = document.getElementById("settingsMenu");
  const btn = document.getElementById("menuBtn");
  const open = menu.classList.toggle("show");
  btn.setAttribute("aria-expanded", open ? "true" : "false");
}

function closeSettingsMenu(){
  document.getElementById("settingsMenu").classList.remove("show");
  document.getElementById("menuBtn").setAttribute("aria-expanded", "false");
}

function escapeToClose(e){
  if (e.key === "Escape"){
    closeVinDropdown();
    closeSettingsMenu();
  }
}

function clickOutsideToClose(e){
  const wrap = document.querySelector(".vinWrap");
  if (!wrap.contains(e.target)){
    closeVinDropdown();
  }
  const menuWrap = document.querySelector(".menuWrap");
  if (!menuWrap.contains(e.target)){
    closeSettingsMenu();
  }
}

function loadSettings(){
  try {
    const raw = localStorage.getItem(SETTINGS_KEY);
    const parsed = raw ? JSON.parse(raw) : {};
    return parsed && typeof parsed === "object" ? parsed : {};
  } catch {
    return {};
  }
}

function saveSettings(next){
  const current = loadSettings();
  const merged = { ...current, ...next };
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(merged));
}

function applyModelPreset(){
  const preset = document.getElementById("modelPreset").value;
  if (!preset) return;
  const modelInput = document.getElementById("modelInput");
  modelInput.value = preset;
  saveSettings({ model: preset });
  setStatus("Model preset saved", true);
}

function onModelInputChange(){
  const model = document.getElementById("modelInput").value.trim();
  saveSettings({ model });
}

function hydrateSettings(){
  const settings = loadSettings();
  const model = (settings.model || "").trim();
  const modelInput = document.getElementById("modelInput");
  const modelPreset = document.getElementById("modelPreset");

  modelInput.value = model;
  const hasPreset = [...modelPreset.options].some(o => o.value === model);
  modelPreset.value = hasPreset ? model : "";
  modelInput.addEventListener("change", onModelInputChange);
  modelInput.addEventListener("blur", onModelInputChange);
}

function buildPayload(){
  const vinValue = document.getElementById("vin").value;
  const diagnosis = document.getElementById("diagnosis").value.trim();
  const repair = document.getElementById("repair").value.trim();
  const notes = document.getElementById("extra").value.trim();
  const mileage = document.getElementById("mileage").value.trim();

  if (!diagnosis && !repair && !notes){
    return { error: "Add diagnosis, repair, or notes before generating." };
  }

  const concernFromNotes = notes;
  const normalizedExtra = mileage ? `Mileage ${mileage}${notes ? ` - ${notes}` : ""}` : notes;

  return {
    payload: {
      mode: document.getElementById("mode").value,
      sectionMode: document.getElementById("sectionMode").value,
      vin: vinValue,
      concern: concernFromNotes,
      diagnosis: diagnosis || "No diagnosis details provided",
      repair: repair || "No repair details provided",
      comment: "",
      parts: document.getElementById("parts").value,
      time: document.getElementById("time").value,
      extra: normalizedExtra,
      model: document.getElementById("modelInput").value.trim()
    }
  };
}

async function generate() {
  const out = document.getElementById("out");
  out.textContent = "";

  const built = buildPayload();
  if (built.error){
    setStatus(built.error, false);
    out.textContent = "Please add at least one input in Diagnosis, Repair, or Notes.";
    return;
  }

  setStatus("Generating...", null);
  setLoading(true);

  addVinToHistory(document.getElementById("vin").value);

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(built.payload)
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      out.textContent = "Could not generate story. Please adjust the text and try again." + (data.details ? "\n\n" + data.details : "");
      setStatus(data.error || "Error returned from API", false);
      setLoading(false);
      return;
    }

    out.textContent = data.story || "";
    setStatus("Done", true);
    setLoading(false);
  } catch (e) {
    out.textContent = "Network error: " + e;
    setStatus("Network error (CORS / blocked / offline)", false);
    setLoading(false);
  }
}

async function copyOut() {
  const text = document.getElementById("out").textContent || "";
  if (!text.trim()){
    setStatus("Nothing to copy", false);
    return;
  }

  try {
    if (navigator.clipboard && window.isSecureContext){
      await navigator.clipboard.writeText(text);
      setStatus("Copied", true);
      return;
    }
  } catch {}

  try {
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.setAttribute("readonly", "");
    ta.style.position = "fixed";
    ta.style.opacity = "0";
    ta.style.left = "-9999px";
    document.body.appendChild(ta);
    ta.select();
    ta.setSelectionRange(0, ta.value.length);
    const ok = document.execCommand("copy");
    document.body.removeChild(ta);
    setStatus(ok ? "Copied" : "Copy blocked (use HTTPS)", ok);
  } catch {
    setStatus("Copy blocked (use HTTPS)", false);
  }
}

function clearAll(){
  ["vin","mileage","diagnosis","repair","parts","time","extra"].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = "";
  });
  document.getElementById("out").textContent = "";
  setStatus("", null);
}

setTheme(getTheme());
renderVinDropdown();
hydrateSettings();

document.addEventListener("keydown", escapeToClose);
document.addEventListener("click", clickOutsideToClose);
</script>
</body>
</html>
